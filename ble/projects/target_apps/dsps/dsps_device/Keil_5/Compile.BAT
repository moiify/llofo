@echo off
chcp 65001
REM å®šä¹‰ç›¸å…³åç§°
rem è“ç‰™å·¥ç¨‹å
set BLE_PRJ_NAME=dsps_device.uvprojx
rem è“ç‰™ç¼–è¯‘æ—¥å¿—æ–‡ä»¶å
set BLE_LOG_FILE_NAME=ble_build_log.txt
rem æœ€ç»ˆè¾“å‡ºè“ç‰™txtæ–‡ä»¶å
set BLE_TXT_FILE_NAME=dacode.txt
rem æœ€ç»ˆè¾“å‡ºè“ç‰™æ•°ç»„å
set BLE_ARRAY_NAME=src_dacode
rem è“ç‰™å·¥ç¨‹è¾“å‡ºç›®å½•
set BLE_OUTPUT_PATH=%cd%\out_585
rem è“ç‰™ç¼–è¯‘å®é…ç½®æ–‡ä»¶å
set BLE_MICRO_FILE_NAME=ble_micro.opt
rem è“ç‰™é…ç½®è„šæœ¬æ–‡ä»¶å
set BLE_CONFIG_FILE_NAME=config.bat

REM å¯»æ‰¾ "config.bat" çš„è·¯å¾„ é»˜è®¤åœ¨åœ¨æœ¬ç›®å½•ä¸‹æ‰¾
if exist "%BLE_CONFIG_FILE_NAME%" (
	set PATH_CONFIG=%cd%
) else ( 
	echo [31;1m  Interrupt: The script "%BLE_CONFIG_FILE_NAME%" not found ! [0m
	pause 
	exit
)

echo PATH_CONFIG: %PATH_CONFIG%

REM å¯»æ‰¾ "Bin2Array.exe" çš„è·¯å¾„ é»˜è®¤åœ¨å¤§ä»“åº“æ ¹ç›®å½•ï¼Œå¦åˆ™ä¸ºå•ç‹¬ç¼–è¯‘åœ¨æœ¬ç›®å½•ä¸‹æ‰¾
if "%REPO_ROOT%"=="" ( 
	if exist "Bin2Array.exe" (
		set PATH_BIN2ARRAY=%cd%
	) else ( 
		echo [31;1m  Interrupt: The tool "Bin2Array.exe" not found ! [0m
		pause 
		exit
	)
) else ( 
	if exist "%REPO_ROOT%\Bin2Array.exe" (
		set PATH_BIN2ARRAY=%REPO_ROOT%
	) else (
		echo [31;1m  Interrupt: The tool "Bin2Array.exe" not found ! [0m
		pause 
		exit
	)
) 
echo PATH_BIN2ARRAY: %PATH_BIN2ARRAY%


REM åˆ é™¤æ—§çš„å®é…ç½®æ–‡ä»¶
if exist "%BLE_MICRO_FILE_NAME%"  del %BLE_MICRO_FILE_NAME%

REM æ¥å—äº§å“ç±»å‹ï¼Œè¾“å‡ºå®é…ç½®æ–‡ä»¶
call %PATH_CONFIG%\%BLE_CONFIG_FILE_NAME% 

REM æ‰“å°å®é…ç½®æ–‡ä»¶å†…å®¹
echo.
echo [36;1m  GET Micro_config File "%BLE_MICRO_FILE_NAME%" : [0m
type %BLE_MICRO_FILE_NAME%
echo.
echo [36;1m  Micro_config File END [0m
echo.

REM é‡ç½®è¾“å‡ºæ–‡ä»¶å¤¹
if exist "%BLE_OUTPUT_PATH%" (
	rd /S /Q %BLE_OUTPUT_PATH%
)
md %BLE_OUTPUT_PATH%
if exist "releaseFile" (
	rd /S /Q .\releaseFile
)
md releaseFile


REM This is the keil project path
set UV_PRO_PATH=.\%BLE_PRJ_NAME%
echo [33;1m  Compiling, plz wait about 30 sec ... [0m
echo [33;1m  compile log will be saved as "%BLE_LOG_FILE_NAME%" [0m

REM PLZ ADD "your mdk5 install path\UV4" to system path "Path", so "UV4.exe" can be found
UV4.EXE -j0 -r %UV_PRO_PATH% -o %cd%\releaseFile\%BLE_LOG_FILE_NAME%
set compile_err=%ERRORLEVEL%

REM æ‰“å°ç¼–è¯‘æ—¥å¿—
type %cd%\releaseFile\%BLE_LOG_FILE_NAME%
REM åˆ é™¤ç”Ÿæˆçš„å®é…ç½®æ–‡ä»¶
if exist "%BLE_MICRO_FILE_NAME%"  del %BLE_MICRO_FILE_NAME%

REM æ‹·è´ä¸€ä»½æ—¥å¿—åˆ°å¤§ä»“åº“çš„æ—¥å¿—ç›®å½•
if not "%REPO_ROOT%"=="" ( 
	copy %BLE_COMPILE_ROOT%\releaseFile\%BLE_LOG_FILE_NAME% %REPO_ROOT%\out\%BLE_LOG_FILE_NAME% 
)


REM ç¼–è¯‘ç»“æœåé¦ˆ
echo [33;1m  error level is %compile_err% [0m
if %compile_err% == 0 (
	echo [32;1m  No Errors or Warnings ! [0m
)

if %compile_err% == 1 (
	echo [32;1m  Warnings  Only ! [0m
)

if %compile_err% geq 2 (
	echo [31;1m  2   Errors ! [0m
	echo [31;1m  3	Fatal Errors [0m
	echo [31;1m  11	Cannot open project file for writing [0m
	echo [31;1m  12	Device with given name in not found in database [0m
	echo [31;1m  13	Error writing project file [0m
	echo [31;1m  15	Error reading import XML file [0m
	echo [31;1m  20	Error converting project [0m
	pause
	exit
)
REM æ‹·è´è¾“å‡ºçš„ BIN æ–‡ä»¶
copy %BLE_OUTPUT_PATH%\dacode.bin .\releaseFile\dacode.bin


REM ç”± bin ç”Ÿæˆ txt
%PATH_BIN2ARRAY%\Bin2Array.exe -i .\releaseFile\dacode.bin -o .\releaseFile\%BLE_TXT_FILE_NAME% -a %BLE_ARRAY_NAME%
if %errorlevel%==0 (
    echo [32;1m DA14585 CODE COMPILE SUCCESSFUL!  [0m
) else (
    echo [31;1m DA14585 CODE COMPILE ERROR!  [0m
    pause
    exit
)

REM å¦‚æœä¸ºå•ç‹¬ç›´æ¥ç¼–è¯‘è“ç‰™ï¼Œåˆ™å®Œæˆååœæ­¢
if "%REPO_ROOT%"=="" ( pause )
